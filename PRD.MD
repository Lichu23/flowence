# Documento de Requisitos del Producto (PRD) para Flowence - Multi-Store Management

## 1. Introducci√≥n

### 1.1 Visi√≥n General del Producto
Flowence es una plataforma web progresiva (PWA) dise√±ada para simplificar la gesti√≥n de m√∫ltiples supermercados o almacenes. **La caracter√≠stica clave es que cada owner puede gestionar m√∫ltiples tiendas desde una sola cuenta**, con roles diferenciados (owner/empleado) y funcionalidades para manejar inventario y ventas independientes por tienda. El MVP se centra en autenticaci√≥n, gesti√≥n multi-tienda, invitaciones por tienda, inventario por tienda y ventas con scanner.

**üè™ Capacidad Multi-Tienda:** A diferencia de sistemas tradicionales, Flowence permite a un emprendedor gestionar todas sus ubicaciones de negocio desde una sola cuenta, con cambio fluido entre tiendas y datos completamente aislados.

### 1.2 Alcance del MVP
- **Incluye:** 
  - Autenticaci√≥n con creaci√≥n autom√°tica de primera tienda
  - Gesti√≥n de m√∫ltiples tiendas por owner
  - Invitaciones de empleados por tienda espec√≠fica
  - Inventario independiente por tienda
  - Ventas con scanner por tienda
  - Procesamiento b√°sico de pagos
  - Configuraci√≥n independiente por tienda
  
- **Excluye (para futuras versiones):**
  - Transferencias de inventario entre tiendas
  - Reportes consolidados multi-tienda
  - Empleados trabajando en m√∫ltiples tiendas
  - Gesti√≥n de franquicias
  - Modo offline
  - Integraciones avanzadas (ERP, contabilidad)

### 1.3 Versi√≥n y Fecha
- **Versi√≥n:** 1.0 (MVP) - Multi-Store Edition
- **Fecha de Creaci√≥n:** Octubre 2025
- **Arquitectura:** Multi-tienda desde el dise√±o inicial

---

## 2. Objetivos y Metas

### 2.1 Objetivos de Negocio
- Permitir a emprendedores gestionar m√∫ltiples ubicaciones de negocio desde una sola cuenta
- Reducir errores manuales en inventario y ventas en al menos un 50%
- Facilitar la expansi√≥n de negocios peque√±os a m√∫ltiples ubicaciones
- Acelerar el proceso de ventas (de minutos a segundos v√≠a scanner)
- Proporcionar herramienta escalable para emprendedores en Latinoam√©rica/Espa√±a

### 2.2 Metas del MVP
- Lanzar versi√≥n funcional donde un owner puede:
  - Crear y gestionar m√∫ltiples tiendas
  - Cambiar entre tiendas sin cerrar sesi√≥n
  - Invitar empleados espec√≠ficos a cada tienda
  - Mantener inventario independiente por tienda
  - Procesar ventas en cualquier tienda
- Tiempo de cambio entre tiendas < 2 segundos
- Datos completamente aislados entre tiendas

### 2.3 M√©tricas de √âxito
- **Adopci√≥n:** 10+ owners gestionando 15+ tiendas en primer mes
- **Uso:** 80% de ventas procesadas sin errores
- **Multi-tienda:** Owners con promedio de 2-3 tiendas por cuenta
- **Feedback:** NPS > 7/10
- **T√©cnicas:** Tiempo de respuesta < 2s; uptime 99%

---

## 3. Audiencia Objetivo

### Usuarios Primarios

#### Owners/Admins
- Due√±os con m√∫ltiples ubicaciones (2-10 tiendas)
- Emprendedores en expansi√≥n
- Necesitan vista consolidada y gesti√≥n independiente por tienda
- Control total sobre todas las tiendas

#### Empleados
- Cajeros/reponedores asignados a tienda espec√≠fica
- Acceso limitado a su tienda asignada
- No ven otras tiendas del owner

### Caracter√≠sticas Demogr√°ficas
- Emprendedores 25-50 a√±os
- Sector retail con m√∫ltiples ubicaciones
- Conocimiento b√°sico de tecnolog√≠a

### Pain Points Resueltos
- **Gesti√≥n fragmentada:** Tener que usar m√∫ltiples sistemas para diferentes tiendas
- **Cambio de contexto:** Necesidad de cerrar y abrir sesi√≥n para cambiar de tienda
- **Datos duplicados:** Reingreso de informaci√≥n en m√∫ltiples sistemas
- **Falta de visi√≥n global:** No poder ver todas las tiendas en un solo lugar
- **Escalabilidad limitada:** Sistemas que no crecen con el negocio

---

## 4. Requisitos Funcionales

### 4.1 Autenticaci√≥n Multi-Tienda (Auth)

#### RF1.1: Registro de Owner con Primera Tienda
- Formulario con: email, contrase√±a, nombre personal, nombre de la tienda
- Al registrarse, autom√°ticamente se crea:
  - Cuenta de usuario con rol "owner"
  - Primera tienda asociada
  - Relaci√≥n usuario-tienda
- Validaci√≥n de email √∫nico
- Contrase√±a m√≠nimo 8 caracteres con complejidad
- Redirecci√≥n a dashboard con tienda activa

#### RF1.2: Login Multi-Tienda
- Login unificado con email/contrase√±a
- Respuesta incluye array de tiendas accesibles
- Si owner: lista todas sus tiendas
- Si empleado: lista tiendas donde est√° invitado
- Token JWT incluye informaci√≥n de usuario y tiendas
- Auto-selecci√≥n de √∫ltima tienda usada (localStorage)

#### RF1.3: Sesi√≥n y Tokens
- JWT con expiraci√≥n de 30 minutos
- Token incluye user_id y rol
- Refresh token para renovaci√≥n
- Logout limpia tokens y contexto de tienda

#### RF1.4: Recuperaci√≥n de Contrase√±a
- Env√≠o de email con link temporal
- Token de recuperaci√≥n v√°lido por 1 hora
- Validaci√≥n de nueva contrase√±a

---

### 4.2 Gesti√≥n Multi-Tienda ‚≠ê

#### RF2.1: Creaci√≥n de Tiendas
- Owner puede crear tiendas ilimitadas
- Formulario: nombre, direcci√≥n, tel√©fono, moneda, tasa de impuesto
- Tienda se asocia autom√°ticamente al owner
- Owner tiene rol "owner" en la tienda creada

#### RF2.2: Listado de Tiendas
- Owner ve todas sus tiendas
- Empleado ve solo tiendas asignadas
- Cada tienda muestra: nombre, direcci√≥n, rol del usuario
- Indicador visual de tienda actualmente seleccionada

#### RF2.3: Selector de Tienda Activa
- Componente visible en todo momento
- Dropdown con lista de tiendas accesibles
- Cambio de tienda sin re-autenticaci√≥n
- Contexto de tienda persiste en localStorage
- Actualizaci√≥n de datos al cambiar tienda

#### RF2.4: Edici√≥n de Tienda
- Solo owner puede editar
- Actualizaci√≥n de informaci√≥n b√°sica
- Configuraci√≥n espec√≠fica de tienda
- Cambios se reflejan inmediatamente

#### RF2.5: Eliminaci√≥n de Tienda
- Solo owner puede eliminar
- Confirmaci√≥n de eliminaci√≥n
- Eliminaci√≥n en cascada de:
  - Productos de la tienda
  - Ventas hist√≥ricas
  - Invitaciones pendientes
  - Relaciones usuario-tienda
- No permite eliminar si es la √∫nica tienda del owner

#### RF2.6: Contexto de Tienda Activa
- Siempre hay una tienda activa seleccionada
- Todas las operaciones usan tienda activa
- Indicador visual permanente de tienda activa
- Breadcrumbs incluyen nombre de tienda

---

### 4.3 Invitaciones por Tienda

#### RF3.1: Invitaci√≥n de Empleados
- Owner invita empleado a **tienda espec√≠fica**
- Formulario: email, tienda destino, rol (empleado)
- Generaci√≥n de token √∫nico v√°lido 24 horas
- Env√≠o de email con link de invitaci√≥n
- Email indica nombre de tienda a la que se invita

#### RF3.2: Aceptaci√≥n de Invitaci√≥n
- Empleado accede al link √∫nico
- Si no tiene cuenta: crea contrase√±a y acepta
- Si ya tiene cuenta: solo acepta invitaci√≥n
- Se crea relaci√≥n user_store con tienda espec√≠fica
- Empleado gana acceso a esa tienda solamente

#### RF3.3: Gesti√≥n de Usuarios por Tienda
- Owner ve lista de empleados por tienda
- Puede ver invitaciones pendientes por tienda
- Puede revocar invitaciones
- Puede remover empleados de tienda espec√≠fica
- Empleado removido pierde acceso a esa tienda

#### RF3.4: Validaci√≥n de Acceso
- Middleware valida acceso a tienda en cada request
- Usuario debe tener relaci√≥n user_store v√°lida
- Error 403 si intenta acceder a tienda no asignada

---

### 4.4 Inventario por Tienda ‚≠ê

#### RF4.1: Productos Espec√≠ficos por Tienda
- Cada producto pertenece a **una tienda espec√≠fica**
- Campo store_id obligatorio en productos
- Barcode √∫nico por tienda (no globalmente)
- Mismo barcode puede existir en diferentes tiendas

#### RF4.2: Registro de Productos
- Owner agrega productos a tienda activa
- Campos: nombre, barcode, precio, costo, stock, categor√≠a, descripci√≥n
- Validaci√≥n de barcode √∫nico dentro de la tienda
- Producto asociado autom√°ticamente a tienda activa

#### RF4.3: Listado de Productos
- Solo muestra productos de tienda activa
- Filtros y b√∫squeda dentro de tienda activa
- Paginaci√≥n de resultados
- Empleados ven productos (solo lectura para algunos campos)

#### RF4.4: Edici√≥n de Productos
- Owner puede editar cualquier campo
- Cambios afectan solo a producto de tienda actual
- Validaci√≥n de barcode al editar (√∫nico en tienda)

#### RF4.5: Stock por Tienda
- Stock es independiente por tienda
- Mismo producto en diferentes tiendas = diferentes stocks
- Alertas de stock bajo por tienda
- Threshold configurable por tienda

#### RF4.6: B√∫squeda por Barcode
- B√∫squeda limitada a tienda activa
- Si barcode no existe en tienda activa: no encontrado
- Opci√≥n de crear producto si no existe

---

### 4.5 Scanner/Ventas por Tienda

#### RF5.1: Scanner con Contexto de Tienda
- Scanner busca productos en tienda activa solamente
- Integraci√≥n con QuaggaJS
- Validaci√≥n de producto en tienda actual
- Fallback a entrada manual

#### RF5.2: Carrito de Ventas
- Carrito es espec√≠fico de tienda activa
- Solo puede contener productos de tienda activa
- Validaci√≥n de stock en tienda activa
- C√°lculo de impuestos seg√∫n configuraci√≥n de tienda

#### RF5.3: Procesamiento de Pagos
- Venta asociada a tienda activa
- Campo store_id en registro de venta
- Soporte para efectivo y tarjeta
- Stock actualizado en tienda activa solamente

#### RF5.4: Recibo de Venta
- Recibo incluye informaci√≥n de tienda
- Direcci√≥n y datos de tienda activa
- PDF generado con branding de tienda
- Registro de venta con store_id

#### RF5.5: Historial de Ventas
- Listado filtrado por tienda activa
- Owner puede ver ventas de cualquier tienda
- Empleado solo ve ventas de su tienda
- Filtros de fecha, empleado, m√©todo de pago

#### RF5.6: Devoluciones
- Devoluci√≥n afecta solo tienda de la venta original
- Stock se restaura en tienda correcta
- Validaci√≥n de tienda activa = tienda de venta

---

### 4.6 Configuraci√≥n por Tienda

#### RF6.1: Configuraci√≥n Independiente
- Cada tienda tiene configuraci√≥n propia
- Moneda espec√≠fica por tienda
- Tasa de impuesto espec√≠fica por tienda
- Threshold de stock bajo por tienda

#### RF6.2: Informaci√≥n de Tienda
- Nombre, direcci√≥n, tel√©fono
- Logo de tienda (opcional)
- Informaci√≥n para recibos
- Datos de contacto

#### RF6.3: Configuraci√≥n de Alertas
- Nivel m√≠nimo de stock configurable
- Alertas espec√≠ficas por tienda
- Notificaciones por tienda

---

### 4.7 Dashboard Multi-Tienda

#### RF7.1: Dashboard para Owner
- Vista de todas las tiendas
- M√©tricas resumidas por tienda
- Comparaci√≥n entre tiendas
- Acceso r√°pido a cada tienda

#### RF7.2: Dashboard para Empleado
- Vista de tienda asignada solamente
- No ve selector de tiendas
- Dashboard espec√≠fico de su tienda

---

### 4.8 Seguridad y Aislamiento de Datos

#### RF8.1: Aislamiento de Datos
- Queries incluyen filtro store_id
- Foreign keys aseguran relaciones
- Middleware valida acceso a tienda
- Logs incluyen store_id

#### RF8.2: Validaci√≥n de Acceso
- Cada request valida user_store relationship
- Error 403 si usuario no tiene acceso
- Logs de intentos de acceso no autorizado

#### RF8.3: Auditor√≠a
- Todos los cambios registran store_id
- Historial de cambios por tienda
- Qui√©n hizo qu√© en qu√© tienda

---

## 5. Requisitos No Funcionales

### 5.1 Rendimiento
- Cambio de tienda < 2 segundos
- Carga de productos < 3 segundos
- Procesamiento de venta < 5 segundos
- Respuesta de API < 500ms promedio

### 5.2 Escalabilidad
- Soporte para owners con 1-100 tiendas
- 1-50 empleados por tienda
- 10,000+ productos por tienda
- 1,000+ ventas diarias por tienda

### 5.3 Seguridad
- HTTPS obligatorio
- JWT con expiraci√≥n
- Passwords hasheados con bcrypt
- Validaci√≥n de acceso a tienda en cada request
- Protecci√≥n contra SQL injection
- Protecci√≥n contra XSS
- Rate limiting por IP

### 5.4 Usabilidad
- Indicador claro de tienda activa siempre visible
- Cambio de tienda intuitivo (1-2 clicks)
- Dise√±o responsive para tablet/m√≥vil
- Interfaz en espa√±ol
- Feedback claro en operaciones

### 5.5 Disponibilidad
- Uptime 99%+
- Backup diario autom√°tico
- Recuperaci√≥n ante fallos
- Monitoreo de errores

---

## 6. Flujos de Usuario Multi-Tienda

### 6.1 Flujo de Registro de Owner
1. Owner accede a registro
2. Ingresa: email, password, nombre, **nombre de primera tienda**
3. Sistema crea cuenta + primera tienda autom√°ticamente
4. Redirecci√≥n a dashboard con tienda activa
5. Bienvenida y opci√≥n de crear m√°s tiendas

### 6.2 Flujo de Creaci√≥n de Segunda Tienda
1. Owner en dashboard
2. Click en "Crear Nueva Tienda"
3. Formulario: nombre, direcci√≥n, configuraci√≥n
4. Tienda creada y a√±adida a lista
5. Opci√≥n de cambiar a nueva tienda

### 6.3 Flujo de Cambio de Tienda
1. Owner/Empleado ve selector en header
2. Click en selector ‚Üí dropdown con tiendas
3. Selecciona otra tienda
4. Contexto cambia, datos se recargan
5. URL puede actualizar (?store_id=X)
6. Toda la app ahora opera en nueva tienda

### 6.4 Flujo de Invitaci√≥n por Tienda
1. Owner en tienda espec√≠fica
2. Va a "Usuarios" ‚Üí "Invitar Empleado"
3. Ingresa email, **la tienda ya est√° seleccionada**
4. Empleado recibe email con nombre de tienda
5. Empleado acepta y queda asignado a esa tienda
6. Empleado solo ver√° esa tienda al login

### 6.5 Flujo de Venta en Tienda Espec√≠fica
1. Empleado/Owner en tienda activa
2. Scanner lee barcode
3. Sistema busca producto **en tienda activa solamente**
4. A√±ade al carrito
5. Procesa venta
6. Venta registrada con store_id
7. Stock actualizado **en tienda activa**
8. Recibo con datos de tienda activa

### 6.6 Flujo de Owner con M√∫ltiples Tiendas
1. Login ‚Üí ve 3 tiendas disponibles
2. Dashboard muestra overview de las 3
3. Click en "Tienda Downtown" ‚Üí cambia contexto
4. Gestiona productos de Downtown
5. Procesa ventas en Downtown
6. Cambia a "Tienda Uptown"
7. Ahora gestiona Uptown
8. Datos de Downtown no visibles en este contexto

---

## 7. Modelo de Datos Multi-Tienda

### 7.1 Entidades Principales

#### Users
```
- id (UUID)
- email (unique)
- password_hash
- name
- role (owner | employee)
```

#### Stores ‚≠ê
```
- id (UUID)
- owner_id (FK ‚Üí users.id)
- name
- address
- phone
- currency
- tax_rate
- low_stock_threshold
```

#### UserStores ‚≠ê (Many-to-Many)
```
- id (UUID)
- user_id (FK ‚Üí users.id)
- store_id (FK ‚Üí stores.id)
- role (owner | employee)
- UNIQUE(user_id, store_id)
```

#### Products
```
- id (UUID)
- store_id (FK ‚Üí stores.id) ‚≠ê
- name
- barcode
- price
- cost
- stock
- category
- UNIQUE(store_id, barcode) ‚≠ê
```

#### Sales
```
- id (UUID)
- store_id (FK ‚Üí stores.id) ‚≠ê
- user_id (FK ‚Üí users.id)
- total
- payment_method
- created_at
```

#### SaleItems
```
- id (UUID)
- sale_id (FK ‚Üí sales.id)
- product_id (FK ‚Üí products.id)
- quantity
- price
```

#### Invitations
```
- id (UUID)
- store_id (FK ‚Üí stores.id) ‚≠ê
- email
- token (unique)
- status
- expires_at
```

### 7.2 Relaciones Clave
- User ‚Üê‚Üí Stores (Many-to-Many via UserStores)
- Store ‚Üí Products (One-to-Many)
- Store ‚Üí Sales (One-to-Many)
- Store ‚Üí Invitations (One-to-Many)

---

## 8. Consideraciones T√©cnicas

### 8.1 Stack Tecnol√≥gico
- **Frontend:** Next.js 14+ con TypeScript, Tailwind CSS
- **Backend:** Node.js/Express con TypeScript
- **Base de Datos:** PostgreSQL (Supabase)
- **Auth:** JWT + Supabase Auth
- **Scanner:** QuaggaJS
- **Pagos:** Stripe
- **Email:** SendGrid

### 8.2 Arquitectura Multi-Tienda
- Contexto de tienda en React Context
- Store_id en todas las queries
- Middleware de validaci√≥n de acceso
- √çndices en store_id para performance
- Constraints de FK para integridad

### 8.3 Testing
- Tests de aislamiento de datos entre tiendas
- Tests de cambio de tienda
- Tests de acceso no autorizado
- Tests de flujos multi-tienda
- E2E con m√∫ltiples tiendas

---

## 9. Asunciones y Riesgos

### 9.1 Asunciones
- Owners t√≠picamente tendr√°n 2-5 tiendas
- Empleados trabajar√°n en una sola tienda (inicialmente)
- Internet estable en tiendas
- Dispositivos modernos con c√°mara

### 9.2 Riesgos Multi-Tienda
| Riesgo | Impacto | Probabilidad | Mitigaci√≥n |
|--------|---------|--------------|------------|
| Confusi√≥n de tienda activa | Alto | Medio | Indicador visual prominente |
| Acceso a tienda incorrecta | Alto | Bajo | Validaci√≥n estricta en middleware |
| Performance con muchas tiendas | Medio | Bajo | √çndices optimizados, paginaci√≥n |
| Complejidad UI para cambio | Medio | Medio | Dise√±o UX cuidadoso, testing |
| Datos mezclados entre tiendas | Cr√≠tico | Bajo | Constraints DB, tests exhaustivos |

---

## 10. Roadmap Post-MVP

### Fase 2: Funcionalidades Avanzadas
- Transferencias de inventario entre tiendas
- Reportes consolidados multi-tienda
- Comparaci√≥n de performance entre tiendas
- Empleados en m√∫ltiples tiendas

### Fase 3: Caracter√≠sticas Empresariales
- Gesti√≥n de franquicias
- Roles personalizados por tienda
- Integraciones contables
- API para terceros

### Fase 4: Optimizaciones
- Modo offline por tienda
- Sincronizaci√≥n avanzada
- Analytics predictivos
- Machine learning para inventario

---

**Versi√≥n:** 1.0 - Multi-Store MVP  
**Fecha:** Octubre 2025  
**Estado:** Especificaci√≥n Completa  
**Pr√≥ximo Paso:** Iniciar Fase 1 de Implementaci√≥n
